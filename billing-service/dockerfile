# syntax=docker/dockerfile:1.7

##########
# Build #
##########
FROM arm64v8/eclipse-temurin:21-jdk AS build
ENV GRADLE_VERSION=8.8
ENV GRADLE_HOME=/opt/gradle
ENV PATH=$PATH:$GRADLE_HOME/bin

# Install Gradle manually
RUN apt-get update && \
    apt-get install -y wget unzip && \
    wget https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip -O /tmp/gradle.zip && \
    mkdir -p /opt/gradle && \
    unzip /tmp/gradle.zip -d /opt/gradle && \
    mv /opt/gradle/gradle-${GRADLE_VERSION}/* /opt/gradle/ && \
    rm -rf /tmp/gradle.zip /opt/gradle/gradle-${GRADLE_VERSION}
WORKDIR /workspace

# Better layer caching: copy only build scripts first
COPY gradle gradle
COPY gradlew .
COPY settings.gradle.kts .
COPY build.gradle.kts .

# Warm Gradle caches (no sources yet)
RUN --mount=type=cache,target=/home/gradle/.gradle/caches \
    --mount=type=cache,target=/home/gradle/.gradle/wrapper \
    ./gradlew --version

# Now copy sources and build
COPY src src
RUN --mount=type=cache,target=/home/gradle/.gradle/caches \
    --mount=type=cache,target=/home/gradle/.gradle/wrapper \
    ./gradlew clean bootJar -x test

###########
# Runtime #
###########
FROM arm64v8/eclipse-temurin:21-jre AS runtime
ENV JAVA_OPTS="-Djava.security.egd=file:/dev/./urandom" \
    SPRING_PROFILES_ACTIVE=prod
WORKDIR /app

# Copy the fat jar produced by Spring Boot
COPY --from=build /workspace/build/libs/*.jar /app/app.jar

EXPOSE 8080
ENTRYPOINT ["sh","-c","java $JAVA_OPTS -jar /app/app.jar"]
